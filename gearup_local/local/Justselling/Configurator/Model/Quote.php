<?php

/**
 * justselling Germany Ltd. EULA
 * http://www.justselling.de/
 * Read the license at http://www.justselling.de/lizenz
 *
 * Do not edit or add to this file, please refer to http://www.justselling.de for more information.
 *
 * @category    justselling
 * @package     justselling_configurator
 * @copyright   Copyright ï¿½ 2012 justselling Germany Ltd. (http://www.justselling.de)
 * @license     http://www.justselling.de/lizenz
 **/

/**
 * @method int getCustomerGroupId()
 * @method Justselling_Configurator_Model_Quote setCustomerGroupId(int $value)
 * @method string getCustomerMiddlename()
 * @method Justselling_Configurator_Model_Quote setCustomerMiddlename(string $value)
 * @method string getCustomerGender()
 * @method Justselling_Configurator_Model_Quote setCustomerGender(string $value)
 * @method string getIsMultiShipping()
 * @method Justselling_Configurator_Model_Quote setIsMultiShipping(string $value)
 * @method string getRemoteIp()
 * @method Justselling_Configurator_Model_Quote setRemoteIp(string $value)
 * @method string getTriggerRecollect()
 * @method Justselling_Configurator_Model_Quote setTriggerRecollect(string $value)
 * @method string getBaseSubtotalWithDiscount()
 * @method Justselling_Configurator_Model_Quote setBaseSubtotalWithDiscount(string $value)
 * @method string getCustomerSuffix()
 * @method Justselling_Configurator_Model_Quote setCustomerSuffix(string $value)
 * @method string getSubtotalWithDiscount()
 * @method Justselling_Configurator_Model_Quote setSubtotalWithDiscount(string $value)
 * @method string getInvoicepdfAddTotals()
 * @method Justselling_Configurator_Model_Quote setInvoicepdfAddTotals(string $value)
 * @method string getGrandTotal()
 * @method Justselling_Configurator_Model_Quote setGrandTotal(string $value)
 * @method string getConvertedAt()
 * @method Justselling_Configurator_Model_Quote setConvertedAt(string $value)
 * @method string getStoreCurrencyCode()
 * @method Justselling_Configurator_Model_Quote setStoreCurrencyCode(string $value)
 * @method string getCustomerTaxvat()
 * @method Justselling_Configurator_Model_Quote setCustomerTaxvat(string $value)
 * @method string getCustomerEmail()
 * @method Justselling_Configurator_Model_Quote setCustomerEmail(string $value)
 * @method string getStoreId()
 * @method Justselling_Configurator_Model_Quote setStoreId(string $value)
 * @method string getCustomerNoteNotify()
 * @method Justselling_Configurator_Model_Quote setCustomerNoteNotify(string $value)
 * @method string getCustomerDob()
 * @method Justselling_Configurator_Model_Quote setCustomerDob(string $value)
 * @method string getSubtotal()
 * @method Justselling_Configurator_Model_Quote setSubtotal(string $value)
 * @method int getOrigOrderId()
 * @method Justselling_Configurator_Model_Quote setOrigOrderId(int $value)
 * @method string getBaseSubtotal()
 * @method Justselling_Configurator_Model_Quote setBaseSubtotal(string $value)
 * @method string getIsVirtual()
 * @method Justselling_Configurator_Model_Quote setIsVirtual(string $value)
 * @method string getUpdatedAt()
 * @method Justselling_Configurator_Model_Quote setUpdatedAt(string $value)
 * @method string getReservedOrderId()
 * @method Justselling_Configurator_Model_Quote setReservedOrderId(string $value)
 * @method string getBaseGrandTotal()
 * @method Justselling_Configurator_Model_Quote setBaseGrandTotal(string $value)
 * @method string getCustomerIsGuest()
 * @method Justselling_Configurator_Model_Quote setCustomerIsGuest(string $value)
 * @method int getGiftMessageId()
 * @method Justselling_Configurator_Model_Quote setGiftMessageId(int $value)
 * @method string getBaseCurrencyCode()
 * @method Justselling_Configurator_Model_Quote setBaseCurrencyCode(string $value)
 * @method string getPasswordHash()
 * @method Justselling_Configurator_Model_Quote setPasswordHash(string $value)
 * @method string getCouponCode()
 * @method Justselling_Configurator_Model_Quote setCouponCode(string $value)
 * @method int getEntityId()
 * @method Justselling_Configurator_Model_Quote setEntityId(int $value)
 * @method string getCustomerFirstname()
 * @method Justselling_Configurator_Model_Quote setCustomerFirstname(string $value)
 * @method string getCustomerLastname()
 * @method Justselling_Configurator_Model_Quote setCustomerLastname(string $value)
 * @method string getCustomerPrefix()
 * @method Justselling_Configurator_Model_Quote setCustomerPrefix(string $value)
 * @method string getStoreToBaseRate()
 * @method Justselling_Configurator_Model_Quote setStoreToBaseRate(string $value)
 * @method string getCheckoutMethod()
 * @method Justselling_Configurator_Model_Quote setCheckoutMethod(string $value)
 * @method string getAppliedRuleIds()
 * @method Justselling_Configurator_Model_Quote setAppliedRuleIds(string $value)
 * @method string getCreatedAt()
 * @method Justselling_Configurator_Model_Quote setCreatedAt(string $value)
 * @method string getBaseToQuoteRate()
 * @method Justselling_Configurator_Model_Quote setBaseToQuoteRate(string $value)
 * @method int getIsChanged()
 * @method Justselling_Configurator_Model_Quote setIsChanged(int $value)
 * @method string getGlobalCurrencyCode()
 * @method Justselling_Configurator_Model_Quote setGlobalCurrencyCode(string $value)
 * @method int getItemsCount()
 * @method Justselling_Configurator_Model_Quote setItemsCount(int $value)
 * @method string getItemsQty()
 * @method Justselling_Configurator_Model_Quote setItemsQty(string $value)
 * @method string getCustomerNote()
 * @method Justselling_Configurator_Model_Quote setCustomerNote(string $value)
 * @method string getStoreToQuoteRate()
 * @method Justselling_Configurator_Model_Quote setStoreToQuoteRate(string $value)
 * @method string getIsActive()
 * @method Justselling_Configurator_Model_Quote setIsActive(string $value)
 * @method string getQuoteCurrencyCode()
 * @method Justselling_Configurator_Model_Quote setQuoteCurrencyCode(string $value)
 * @method int getCustomerTaxClassId()
 * @method Justselling_Configurator_Model_Quote setCustomerTaxClassId(int $value)
 * @method string getBaseToGlobalRate()
 * @method Justselling_Configurator_Model_Quote setBaseToGlobalRate(string $value)
 * @method string getIsPersistent()
 * @method Justselling_Configurator_Model_Quote setIsPersistent(string $value)
 * @method int getCustomerId()
 * @method Justselling_Configurator_Model_Quote setCustomerId(int $value)
 * @method string getExtShippingInfo()
 * @method Justselling_Configurator_Model_Quote setExtShippingInfo(string $value)
 */
class Justselling_Configurator_Model_Quote extends Mage_Sales_Model_Quote
{
    /**
     * (non-PHPdoc)
     * @see Mage_Sales_Model_Quote::addProduct($product, $request)
     */
    public function addProduct(Mage_Catalog_Model_Product $product, $request = null)
    {
       // print_r($request->getData());exit;
        $item = NULL;
        $conf_product = false;
      
        if( $request instanceof Varien_Object ) {

            $requestData = $request->getData();

            $qty = $request->getQty();
            if ($qty == 0) {
                $qty = 1;
            }
            $options = $product->getOptions();
            $altProducts = array();
            $altCheckout = $requestData['altCheckout']?true:false;
            $optionsLeft = 0;

            foreach($options as $option) {
                if( $option->getType() == 'configurator' ) {
                    $conf_product = true;

                    $optionId = $option->getOptionId();
                    $templateId = Mage::getModel('configurator/template')->getLinkedTemplateId($optionId);
                    $templateModel = Mage::getModel('configurator/template')->load($templateId);
                   // $altCheckout = (bool) $templateModel->getAltCheckout();

                    if( isset($requestData['options'][$optionId]))	{
                        foreach($requestData['options'][$optionId] as $templateJsId => $template) {
                            $custom_option = new Justselling_Configurator_Model_Product_Option_Type_Custom();
                            $custom_options = $custom_option->getTemplateOption(serialize($requestData['options'][$optionId]));
                            $option_price = array();
                            foreach ($custom_options as $opt) {
                                if (isset($opt['option']['id'])) {
                                    $option_price[$opt['option']['id']] = $opt['value']['price'];
                                }
                            }
                            $templateOptionValues = $template['template'];
                            // TODO If Einzelartikel is set than some options where not shown at the cart view
                            if ($altCheckout) {
                                foreach ($templateOptionValues as $templateOptionId => $templateOptionValue) {
                                    $templateOptionModel = Mage::getModel('configurator/option')->load($templateOptionId);
                                    $productId = $templateOptionModel->getProductId();
                                    if($productId !== null){
                                        $alt_product = Mage::getModel('catalog/product')->load($productId);
                                        
                                    }
                                    $price = 0.0;
                                    if (isset($option_price[$templateOptionId])) {
                                        $price = $option_price[$templateOptionId];
                                    }

                                    if (in_array($templateOptionModel->getType(), array('select', 'radiobuttons', 'listimage', 'selectcombi', 'listimagecombi', "overlayimage", 'overlayimagecombi', 'textimage'))) {
                                        $valueModel = Mage::getModel('configurator/value')->load($templateOptionValue);
                                        if ($valueModel->getProductId())
                                            $productId = $valueModel->getProductId();
                                    }

                                    if (isset($templateOptionModel) && $productId === null && $templateOptionModel->getIsVisible() != 1) {
                                        unset($requestData["options"][$optionId][$templateJsId]["template"][$templateOptionId]);
                                    }

                                    if (isset($templateOptionModel) && $productId !== null) {
                                        unset($requestData["options"][$optionId][$templateJsId]["template"][$templateOptionId]);
                                        
                                        $type = $templateOptionModel->getType();
                                        $value = null;
                                        switch ($type) {
                                            case 'select':
                                            case 'listimage':
                                            case 'selectcombi':
                                            case 'selectcombi':
                                            case 'textimage':
                                            case 'listimagecombi':
                                            case 'radiobuttons':
                                            case 'overlayimage' :
                                            case 'overlayimagecombi' :
                                                $valueModel = Mage::getModel('configurator/value')->load($templateOptionValue);
                                                $value = 0.0 + $valueModel->getValue();
                                                break;
                                            default:
                                                $value = $templateOptionValue;
                                                $value= str_replace(",",".",$value);
                                                $value = 0.0 + $value;
                                                break;
                                        }

                                        if ($value !== null && $value != 0) {
                                            $item_qty = $value * $qty;
                                        } else {
                                            $item_qty =  $qty;
                                        }
                                        if ($value === 0 || $value == '0') {
                                            $item_qty = 0;
                                        }

                                        if ($item_qty > 0) {
                                            if (Mage::getStoreConfig('productconfigurator/stock/minordercheck')) {
                                                $stock_item = $alt_product->getStockItem();
                                                if ($stock_item) {
                                                    $min_sale_qty = $stock_item->getMinSaleQty();
                                                    if ($min_sale_qty > $item_qty) {
                                                        $item_qty = $min_sale_qty;
                                                    }
                                                }
                                            }
                                            if (Mage::getStoreConfig('productconfigurator/stock/maxordercheck')) {
                                                $stock_item = $alt_product->getStockItem();
                                                if ($stock_item) {
                                                    $max_sale_qty = $stock_item->getMaxSaleQty();
                                                    if ($item_qty > $max_sale_qty) {
                                                        $item_qty = $max_sale_qty;
                                                    }
                                                }
                                            }

                                            if (Mage::getStoreConfig('productconfigurator/stock/incrementsordercheck')) {
                                                $stock_item = $alt_product->getStockItem();
                                                if ($stock_item && $stock_item->getEnableQtyIncrements()) {
                                                    $increments = $stock_item->getQtyIncrements();
                                                    if ($increments) {
                                                        $in = floor($item_qty / $increments);
                                                        if ($item_qty - ($in * $increments) != 0) {
                                                            $item_qty = (round($item_qty / $increments,0)+1)*$increments;
                                                        }
                                                    }
                                                }
                                            }

                                            $altProducts[] = array('product' => $alt_product, 'qty' =>  $item_qty, 'price' => $price);
                                        }
                                    }
                                }
                            }
                            if (sizeof($requestData["options"][$optionId][$templateJsId]["template"]) > 0) {
                                $optionsLeft += sizeof($requestData["options"][$optionId][$templateJsId]["template"]);
                            }
                        }
                    }
                }
            }

            // Delete all options with value 0
            if ($altCheckout)
                foreach ($requestData["options"][$optionId][$templateJsId]["template"] as $option_id => $option_value_id) {
                    $option = Mage::getModel("configurator/option")->load($option_id);
                    $value = NULL;
                    switch ($option->getType()) {
                        case 'select':
                        case 'listimage':
                        case 'selectcombi':
                        case 'selectcombi':
                        case 'listimagecombi':
                        case 'radiobuttons':
                        case 'overlayimage' :
                        case 'overlayimagecombi' :
                            $valueModel = Mage::getModel('configurator/value')->load($option_value_id);
                            $value = $valueModel->getValue();
                            break;
                        default:
                            $value = $option_value_id;
                            break;
                    }
                    if ($value === 0) {
                        unset($requestData["options"][$optionId][$templateJsId]["template"][$option_id]);
                        $optionsLeft--;
                    }
                }

            /* When there are alt products then add them to the cart */
            if( $altCheckout && count($altProducts) > 0 ) {
                $item = null;
                foreach($altProducts as $altProduct) {
                    if ($altProduct['qty'] >= 1) {

                        $item = parent::addProduct($altProduct['product'],$altProduct['qty']);
                       
                        if (Mage::getStoreConfig('productconfigurator/stock/price')) {
                            $item->setCustomPrice($altProduct['price']);
                            $item->setOriginalCustomPrice($altProduct['price']);
                        }
                    }
                }
            }

            /* If there are any other configurator options then add a configuration product to the cart */
            if (($altCheckout && count($altProducts)  == 0) || ($altCheckout && $optionsLeft && Mage::getStoreConfig('productconfigurator/stock/configuration') == '1') || ($altCheckout && Mage::getStoreConfig('productconfigurator/stock/configuration') == '2')) {
                $request->setData($requestData);
                $item =  parent::addProduct($product,$request);
            }

            /* If we have a configurator product but we do not have the alt-checkout active */
            if ($conf_product && !$altCheckout) {               
		$item = parent::addProduct ( $product, $request );                                         
                return $item;
            }
            
            if ($conf_product) {              
                return $item;
            }
        }

        return parent::addProduct ( $product, $request );
    }

}
