<?php
/**
 * Mage SMS - SMS notification & SMS marketing
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the BSD 3-Clause License
 * It is available through the world-wide-web at this URL:
 * http://opensource.org/licenses/BSD-3-Clause
 *
 * @category    TOPefekt
 * @package     TOPefekt_Magesms
 * @copyright   Copyright (c) 2012-2017 TOPefekt s.r.o. (http://www.mage-sms.com)
 * @license     http://opensource.org/licenses/BSD-3-Clause
 */
 class Topefekt_Magesms_Model_BirthdayMessages_Observer { public function customersmsGroups(Varien_Event_Observer $i417760717250c854293598d2ff07a66629a1946d) { if (!Mage::getStoreConfig('magesms/birthday/enabled')) return $this; $ie54fcd5470bd7f31f709089290e33bb03e655c25 = $this->f69d077045ec67fdb80677c5f2c3a640cf42697a2(); $i7137e40370cf1c5ccf937060891613788203e2d6 = Mage::app()->getRequest()->getParam('mutation', reset($ie54fcd5470bd7f31f709089290e33bb03e655c25)); $iefc930e6dfdf3023610ed7d663c73d176a7544e0 = Mage::helper('magesms')->__(Mage::getConfig()->getNode('default/birthdaymessages/template')->default); $i1ddb77d41f3678bb92f39c5c4d47aa6e58d4b89e = Mage::getModel('magesms/birthdaymessages_template')->getCollection(); $i1ddb77d41f3678bb92f39c5c4d47aa6e58d4b89e->addFieldToFilter('mutation', $i7137e40370cf1c5ccf937060891613788203e2d6); $i705fa7c9639d497e1179d7d5691c212668a8c9c8 = $i1ddb77d41f3678bb92f39c5c4d47aa6e58d4b89e->getFirstItem(); $i705fa7c9639d497e1179d7d5691c212668a8c9c8->setGroup('birthdaymessages') ->setName('birthdayMessages') ->setPlugin('topefekt_birthdaymessages') ->setInfo(Mage::helper('magesms')->__('Birthday Messages notification')) ->setTemplate2($i705fa7c9639d497e1179d7d5691c212668a8c9c8->getSmstext() ? $i705fa7c9639d497e1179d7d5691c212668a8c9c8->getSmstext() : $iefc930e6dfdf3023610ed7d663c73d176a7544e0) ->setNotice('{customer_id}, {customer_email}, {customer_password}, {customer_lastname}, {customer_firstname}<br /><br />{shop_domain}, {shop_name}, {shop_email}, {shop_phone}'); if (!$i705fa7c9639d497e1179d7d5691c212668a8c9c8->getRunTime()) { $i705fa7c9639d497e1179d7d5691c212668a8c9c8->setRunTime(Mage::getConfig()->getNode('default/birthdaymessages/template')->time); } $i1791b2d1f89bb2bd83b34046f59125af207713db = Mage::app()->getLayout()->createBlock('Mage_Core_Block_Template')->setTemplate('topefekt/magesms/birthdaymessages/form.phtml'); $i5d4a7167ae6f10601ecf7cb73a87e638ab815fde = array( array('value' => 0, 'title' => Mage::helper('magesms')->__('on birthday')), array('value' => -1, 'title' => Mage::helper('magesms')->__('-1 day')), array('value' => -2, 'title' => Mage::helper('magesms')->__('-2 days')), array('value' => -3, 'title' => Mage::helper('magesms')->__('-3 days')), array('value' => -4, 'title' => Mage::helper('magesms')->__('-4 days')), array('value' => -5, 'title' => Mage::helper('magesms')->__('-5 days')), array('value' => -7, 'title' => Mage::helper('magesms')->__('-7 days')), array('value' => -14, 'title' => Mage::helper('magesms')->__('-14 days')), ); foreach($i5d4a7167ae6f10601ecf7cb73a87e638ab815fde as &$i9b0c07ee5a5a3ac4f600994a3a25b10d6c6dd015) { if ($i9b0c07ee5a5a3ac4f600994a3a25b10d6c6dd015['value'] == $i705fa7c9639d497e1179d7d5691c212668a8c9c8->getDelay()) $i9b0c07ee5a5a3ac4f600994a3a25b10d6c6dd015['selected'] = true; else $i9b0c07ee5a5a3ac4f600994a3a25b10d6c6dd015['selected'] = false; } $i1791b2d1f89bb2bd83b34046f59125af207713db->setDelay($i5d4a7167ae6f10601ecf7cb73a87e638ab815fde); list($i763af8c0bf60af676bd6009608530e253f26d465, $i7627de5569d5cb4533fb00a68acc5f866e381c5b) = explode(':', $i705fa7c9639d497e1179d7d5691c212668a8c9c8->getRunTime()); $i1791b2d1f89bb2bd83b34046f59125af207713db->setRunTimeHour($i763af8c0bf60af676bd6009608530e253f26d465); $i1791b2d1f89bb2bd83b34046f59125af207713db->setRunTimeMinute($i7627de5569d5cb4533fb00a68acc5f866e381c5b); $i705fa7c9639d497e1179d7d5691c212668a8c9c8->setCustomForm($i1791b2d1f89bb2bd83b34046f59125af207713db->toHtml()); $i417760717250c854293598d2ff07a66629a1946d['groups']->addItem(new Varien_Object(array( 'group' => 'birthdaymessages', 'name' => Mage::helper('magesms')->__('Birthday Messages'), 'hooks' => array($i705fa7c9639d497e1179d7d5691c212668a8c9c8->getName() => $i705fa7c9639d497e1179d7d5691c212668a8c9c8) ))); return $this; } public function save(Varien_Event_Observer $i417760717250c854293598d2ff07a66629a1946d) { if (!Mage::getStoreConfig('magesms/birthday/enabled')) return $this; $i2e233784f2a54347fff339d5268a637485c8d940 = Mage::app()->getRequest(); if ($i2e233784f2a54347fff339d5268a637485c8d940->getParam('plugin') != 'topefekt_birthdaymessages') return $this; $ie54fcd5470bd7f31f709089290e33bb03e655c25 = $this->f69d077045ec67fdb80677c5f2c3a640cf42697a2(); $i7137e40370cf1c5ccf937060891613788203e2d6 = $i2e233784f2a54347fff339d5268a637485c8d940->getParam('mutation', reset($ie54fcd5470bd7f31f709089290e33bb03e655c25)); $idb618c56be2c8abc9a54a16881dadfd5317ba624 = Mage::getModel('magesms/birthdaymessages_template')->getCollection(); $idb618c56be2c8abc9a54a16881dadfd5317ba624->addFieldToFilter('mutation', $i7137e40370cf1c5ccf937060891613788203e2d6); $iefc930e6dfdf3023610ed7d663c73d176a7544e0 = $idb618c56be2c8abc9a54a16881dadfd5317ba624->getFirstItem(); $iefc930e6dfdf3023610ed7d663c73d176a7544e0->setMutation($i7137e40370cf1c5ccf937060891613788203e2d6); $iefc930e6dfdf3023610ed7d663c73d176a7544e0->setRunTime($i2e233784f2a54347fff339d5268a637485c8d940->getParam('run_time_hour').':'.$i2e233784f2a54347fff339d5268a637485c8d940->getParam('run_time_min').':00'); $iefc930e6dfdf3023610ed7d663c73d176a7544e0->setDelay($i2e233784f2a54347fff339d5268a637485c8d940->getParam('delay')); $iefc930e6dfdf3023610ed7d663c73d176a7544e0->setSmstext($i2e233784f2a54347fff339d5268a637485c8d940->getParam('text')); $iefc930e6dfdf3023610ed7d663c73d176a7544e0->setActive($i2e233784f2a54347fff339d5268a637485c8d940->getParam('active') ? 1 : 0); $iefc930e6dfdf3023610ed7d663c73d176a7544e0->save(); } public function cron() { if (!Mage::getStoreConfig('magesms/birthday/enabled')) return $this; $iff7e46827cbb6547116c592bf800f4687428abf9 = Mage::getModel('magesms/birthdaymessages_template')->getCollection(); $iff7e46827cbb6547116c592bf800f4687428abf9->addFieldToFilter('active', 1); if (!$iff7e46827cbb6547116c592bf800f4687428abf9->count()) return $this; $iefc930e6dfdf3023610ed7d663c73d176a7544e0 = $iff7e46827cbb6547116c592bf800f4687428abf9->getFirstItem(); Mage::log("MageSms BirthdayMessages cron - run"); $ib74b960a19e96c6107348a44a072d3d572782356 = Mage::getStoreConfig('magesms/birthday/run'); $ic69c406967f5c7f4ff71422703f9dff657d8de71 = Mage::getModel('core/date')->timestamp(); if (!$ib74b960a19e96c6107348a44a072d3d572782356) { if ($ic69c406967f5c7f4ff71422703f9dff657d8de71 < strtotime($ib74b960a19e96c6107348a44a072d3d572782356.' '.$iefc930e6dfdf3023610ed7d663c73d176a7544e0->getRunTime())) { $ib74b960a19e96c6107348a44a072d3d572782356 = date('Y-m-d', Mage::getModel('core/date')->timestamp()); } else { $ib74b960a19e96c6107348a44a072d3d572782356 = date('Y-m-d', Mage::getModel('core/date')->timestamp(strtotime('+1 day'))); } Mage::getModel('core/config')->saveConfig('magesms/birthday/run', $ib74b960a19e96c6107348a44a072d3d572782356); Mage::getConfig()->reinit(); Mage::app()->reinitStores(); } if ($ic69c406967f5c7f4ff71422703f9dff657d8de71 >= strtotime($ib74b960a19e96c6107348a44a072d3d572782356.' '.$iefc930e6dfdf3023610ed7d663c73d176a7544e0->getRunTime())) { Mage::log("MageSms BirthdayMessages cron - searching customers"); $ibad8f78c098260b16424eb12ceee5f8336591d56 = Mage::helper('magesms')->getCustomerCollection(); $ibad8f78c098260b16424eb12ceee5f8336591d56->addFieldToFilter('dob', array('notnull' => true)); $i5d4a7167ae6f10601ecf7cb73a87e638ab815fde = $ic69c406967f5c7f4ff71422703f9dff657d8de71; if ($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getDelay()) { $i5d4a7167ae6f10601ecf7cb73a87e638ab815fde = strtotime('+'.(-1 * $iefc930e6dfdf3023610ed7d663c73d176a7544e0->getDelay()).' day', $ic69c406967f5c7f4ff71422703f9dff657d8de71); } $ibad8f78c098260b16424eb12ceee5f8336591d56->getSelect()->where('(at_dob.value LIKE \'____-'.date('m', $i5d4a7167ae6f10601ecf7cb73a87e638ab815fde).'-'.date('d', $i5d4a7167ae6f10601ecf7cb73a87e638ab815fde).' %\')'); if ($ibad8f78c098260b16424eb12ceee5f8336591d56->count()) { Mage::log("MageSms BirthdayMessages cron - found ".$ibad8f78c098260b16424eb12ceee5f8336591d56->count()." customer(s)"); $i6abff7c4dab2aa28578ae1dc49699ba6b1d18c18 = Mage::getSingleton('magesms/smsprofile'); $i1ddb77d41f3678bb92f39c5c4d47aa6e58d4b89e = Mage::getModel('magesms/birthdaymessages_template')->getCollection(); $i1ddb77d41f3678bb92f39c5c4d47aa6e58d4b89e->addFieldToFilter('mutation', array('nlike' => 'default')); $i1ddb77d41f3678bb92f39c5c4d47aa6e58d4b89e->addFieldToFilter('active', 1); foreach ($ibad8f78c098260b16424eb12ceee5f8336591d56 as $i21e55df616c305955791876c1eb4da83448beba2) { if ($i6abff7c4dab2aa28578ae1dc49699ba6b1d18c18->user->getPrefbilling()) { $i1f1945594819c4321de45ac15ed6d4dc07f41e2f = $i21e55df616c305955791876c1eb4da83448beba2->getShippingTelephone(); $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b = $i21e55df616c305955791876c1eb4da83448beba2->getShippingCountryId(); if (!$i1f1945594819c4321de45ac15ed6d4dc07f41e2f) { $i1f1945594819c4321de45ac15ed6d4dc07f41e2f = $i21e55df616c305955791876c1eb4da83448beba2->getTelephone(); $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b = $i21e55df616c305955791876c1eb4da83448beba2->getBillingCountryId(); } } else { $i1f1945594819c4321de45ac15ed6d4dc07f41e2f = $i21e55df616c305955791876c1eb4da83448beba2->getBillingTelephone(); $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b = $i21e55df616c305955791876c1eb4da83448beba2->getBillingCountryId(); if (!$i1f1945594819c4321de45ac15ed6d4dc07f41e2f) { $i1f1945594819c4321de45ac15ed6d4dc07f41e2f = $i21e55df616c305955791876c1eb4da83448beba2->getTelephone(); $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b = $i21e55df616c305955791876c1eb4da83448beba2->getShippingCountryId(); } } $ifb2b31a17a2f13d19aebc5823ae02f42988a78f2 = $i21e55df616c305955791876c1eb4da83448beba2->getEntityId(); $i489c048e0604d314330360b5ee23b42f486ebb98 = $i21e55df616c305955791876c1eb4da83448beba2->getLastName(). ' '.$i21e55df616c305955791876c1eb4da83448beba2->getFirstName(); if ($idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b) { $i854b57231c05dbaa7f22331dbaed4152a402d2f1 = new Zend_Locale_Data(); $i065c883e3f45e58104d21f8196ee3fe9bd2f513d = $i854b57231c05dbaa7f22331dbaed4152a402d2f1->getList('en-EN', 'phonetoterritory'); $i7492a7ab99a6ff1e0ae253366480ecb40a550224 = $i065c883e3f45e58104d21f8196ee3fe9bd2f513d[$idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b]; } else { $i7492a7ab99a6ff1e0ae253366480ecb40a550224 = ''; } $i6d6da9eb4bc3bca1db3f4eb2b907f496d625d20f = $iefc930e6dfdf3023610ed7d663c73d176a7544e0->getSmstext(); foreach($i1ddb77d41f3678bb92f39c5c4d47aa6e58d4b89e as $i4df015c4c10bbcf1d38137f3659b01221d2dc076) { if ($i4df015c4c10bbcf1d38137f3659b01221d2dc076->getMutation() == $i7492a7ab99a6ff1e0ae253366480ecb40a550224) { $i6d6da9eb4bc3bca1db3f4eb2b907f496d625d20f = $i4df015c4c10bbcf1d38137f3659b01221d2dc076->getSmstext(); break; } } if ($i6d6da9eb4bc3bca1db3f4eb2b907f496d625d20f) { $if739aceffec69fa2733946a3d319defaa354082d = Mage::getModel('magesms/hooks'); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f = Mage::getModel('magesms/sms'); $i5e65dd16263683749d16a84171f719e768ed14b5 = Mage::getModel('customer/customer')->load($ifb2b31a17a2f13d19aebc5823ae02f42988a78f2); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->addRecipient($i1f1945594819c4321de45ac15ed6d4dc07f41e2f, array('recipient' => $i489c048e0604d314330360b5ee23b42f486ebb98, 'customerId' => $ifb2b31a17a2f13d19aebc5823ae02f42988a78f2, 'country' => $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b)) ->setMessage($if739aceffec69fa2733946a3d319defaa354082d->prepareText($i6d6da9eb4bc3bca1db3f4eb2b907f496d625d20f, 'customerRegisterSuccess', $i5e65dd16263683749d16a84171f719e768ed14b5)) ->setSubject('birthdayMessages') ->setType(Topefekt_Magesms_Model_Sms::TYPE_CUSTOMER) ->setPriority(true) ->setCustomerId($ifb2b31a17a2f13d19aebc5823ae02f42988a78f2) ->setStoreId($i21e55df616c305955791876c1eb4da83448beba2->getStoreId()); $if2014d170e15e7f6f64523fd3238720980ceb64a = Mage::getSingleton('magesms/hooks_unicode')->getCollection() ->addFieldToFilter('type', 'customer'); foreach($if2014d170e15e7f6f64523fd3238720980ceb64a as $ie8d90f6313614fbb6564426c0b0cb59a0ca4cecd) { if ($ie8d90f6313614fbb6564426c0b0cb59a0ca4cecd->getArea() == $i7492a7ab99a6ff1e0ae253366480ecb40a550224) { $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setUnicode($ie8d90f6313614fbb6564426c0b0cb59a0ca4cecd->getUnicode()); break; } elseif ($ie8d90f6313614fbb6564426c0b0cb59a0ca4cecd->getArea() == 'default') $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setUnicode($ie8d90f6313614fbb6564426c0b0cb59a0ca4cecd->getUnicode()); } $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setHookName('birthdayMessages'); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->send(); Mage::log("MageSms BirthdayMessages cron - send sms to ".$i5e65dd16263683749d16a84171f719e768ed14b5->getName().' ('.$i1f1945594819c4321de45ac15ed6d4dc07f41e2f.')'); } } } Mage::getModel('core/config')->saveConfig('magesms/birthday/run', date('Y-m-d', Mage::getModel('core/date')->timestamp(strtotime('+1 day')))); Mage::getConfig()->reinit(); Mage::app()->reinitStores(); } Mage::log("MageSms BirthdayMessages cron - end"); return $this; } private function f69d077045ec67fdb80677c5f2c3a640cf42697a2() { $ie54fcd5470bd7f31f709089290e33bb03e655c25 = array(); $ice21cd4390308309015957a221ff2bff67f397ce = Mage::app()->getLocale()->getOptionLocales(); foreach (Mage::app()->getStores() as $i3763a59a4c1873eeb396b46caa87140ccb7bc631) { $ia35eb6e21739b9f362d4085ebe7dee274bc421a7 = Mage::getStoreConfig('general/locale/code', $i3763a59a4c1873eeb396b46caa87140ccb7bc631->getId()); if (in_array($ia35eb6e21739b9f362d4085ebe7dee274bc421a7, $ie54fcd5470bd7f31f709089290e33bb03e655c25)) { continue; } foreach ($ice21cd4390308309015957a221ff2bff67f397ce as $i4e4643965424fd5279d5992f6c669c0a56d9a1a3) { if ($i4e4643965424fd5279d5992f6c669c0a56d9a1a3['value'] == $ia35eb6e21739b9f362d4085ebe7dee274bc421a7) { $ie54fcd5470bd7f31f709089290e33bb03e655c25[] = $ia35eb6e21739b9f362d4085ebe7dee274bc421a7; break; } } } return $ie54fcd5470bd7f31f709089290e33bb03e655c25; } } 