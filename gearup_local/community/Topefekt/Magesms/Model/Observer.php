<?php
/**
 * Mage SMS - SMS notification & SMS marketing
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the BSD 3-Clause License
 * It is available through the world-wide-web at this URL:
 * http://opensource.org/licenses/BSD-3-Clause
 *
 * @category    TOPefekt
 * @package     TOPefekt_Magesms
 * @copyright   Copyright (c) 2012-2017 TOPefekt s.r.o. (http://www.mage-sms.com)
 * @license     http://opensource.org/licenses/BSD-3-Clause
 */
 class Topefekt_Magesms_Model_Observer { public function updateOrderTrackingNumber(Varien_Event_Observer $i417760717250c854293598d2ff07a66629a1946d) { $i5e65dd16263683749d16a84171f719e768ed14b5 = $i417760717250c854293598d2ff07a66629a1946d->getEvent()->getTrack(); if ($i5e65dd16263683749d16a84171f719e768ed14b5->hasDataChanges() && ($i5e65dd16263683749d16a84171f719e768ed14b5->getData('created_at') == $i5e65dd16263683749d16a84171f719e768ed14b5->getData('updated_at') || $i5e65dd16263683749d16a84171f719e768ed14b5->dataHasChangedFor('track_number')) ) { if (Mage::registry('magesms_track_obj')) Mage::unregister('magesms_track_obj'); Mage::register('magesms_track_obj', $i5e65dd16263683749d16a84171f719e768ed14b5); Mage::getSingleton('magesms/hooks')->send('updateOrderTrackingNumber', $i5e65dd16263683749d16a84171f719e768ed14b5->getShipment()->getOrder()); } return $this; } public function newOrder(Varien_Event_Observer $i417760717250c854293598d2ff07a66629a1946d) { if (!Mage::helper('magesms')->isActive()) return $this; if ($i417760717250c854293598d2ff07a66629a1946d->getEvent()->getOrder()->getRelationParentId()) { Mage::register('magesms_edit_order', true, true); return $this; } $i69a1201e93806d55c970dfb18feec53d221ba37b = Mage::helper('magesms')->getOptoutProduct(); if ($i69a1201e93806d55c970dfb18feec53d221ba37b) { $if80f0cbea56595a4489db73147386c11bb406a7e = $i417760717250c854293598d2ff07a66629a1946d->getEvent()->getOrder(); $i705fa7c9639d497e1179d7d5691c212668a8c9c8 = $if80f0cbea56595a4489db73147386c11bb406a7e->getQuote()->getItemByProduct($i69a1201e93806d55c970dfb18feec53d221ba37b); if (!$i705fa7c9639d497e1179d7d5691c212668a8c9c8) { $ib8129b89cda7dae2cfe1b114353de8ba2385974e = Mage::getModel('magesms/optout_order'); $ib8129b89cda7dae2cfe1b114353de8ba2385974e->setOrderId($if80f0cbea56595a4489db73147386c11bb406a7e->getId())->setDisabled(1); $ib8129b89cda7dae2cfe1b114353de8ba2385974e->save(); } } Mage::getSingleton('magesms/hooks')->send('newOrder', $i417760717250c854293598d2ff07a66629a1946d->getOrder()); return $this; } public function updateOrderStatus(Varien_Event_Observer $i417760717250c854293598d2ff07a66629a1946d) { if (Mage::registry('magesms_edit_order')) return $this; if ($i417760717250c854293598d2ff07a66629a1946d->getOrder()->getOrigData('status') != $i417760717250c854293598d2ff07a66629a1946d->getOrder()->getData('status')) { Mage::getSingleton('magesms/hooks')->send('updateOrderStatus', $i417760717250c854293598d2ff07a66629a1946d->getOrder()); } return $this; } public function createCreditMemo(Varien_Event_Observer $i417760717250c854293598d2ff07a66629a1946d) { Mage::getSingleton('magesms/hooks')->send('createCreditMemo', $i417760717250c854293598d2ff07a66629a1946d); return $this; } public function customerRegisterSuccess(Varien_Event_Observer $i417760717250c854293598d2ff07a66629a1946d) { Mage::getSingleton('magesms/hooks')->send('customerRegisterSuccess', $i417760717250c854293598d2ff07a66629a1946d['customer']); return $this; } public function productStock(Varien_Event_Observer $i417760717250c854293598d2ff07a66629a1946d) { $i5e65dd16263683749d16a84171f719e768ed14b5 = $i417760717250c854293598d2ff07a66629a1946d->getEvent()->getItem(); if ($i5e65dd16263683749d16a84171f719e768ed14b5->getManageStock()) { if (!($i34b2041d68b0c6d2dfd61d3d36f96caad687688c = Mage::registry('magesms_stock_item_' . $i5e65dd16263683749d16a84171f719e768ed14b5->getProductId()))) { $i34b2041d68b0c6d2dfd61d3d36f96caad687688c = $i5e65dd16263683749d16a84171f719e768ed14b5->getOrigData(); } if (!$i34b2041d68b0c6d2dfd61d3d36f96caad687688c) return $this; if ($i5e65dd16263683749d16a84171f719e768ed14b5->hasDataChanges()) { if ($i34b2041d68b0c6d2dfd61d3d36f96caad687688c['qty'] > 0 && $i5e65dd16263683749d16a84171f719e768ed14b5->getQty() <= 0) Mage::getSingleton('magesms/hooks')->send('productOutOfStock', $i5e65dd16263683749d16a84171f719e768ed14b5); if ($i5e65dd16263683749d16a84171f719e768ed14b5->getNotifyStockQty() > $i5e65dd16263683749d16a84171f719e768ed14b5->getQty() && $i34b2041d68b0c6d2dfd61d3d36f96caad687688c['qty'] >= $i5e65dd16263683749d16a84171f719e768ed14b5->getNotifyStockQty()) Mage::getSingleton('magesms/hooks')->send('productLowStock', $i5e65dd16263683749d16a84171f719e768ed14b5); } } return $this; } public function contactForm(Varien_Event_Observer $i417760717250c854293598d2ff07a66629a1946d) { if (!Mage::helper('magesms')->isActive()) return $this; Mage::getSingleton('magesms/hooks')->send('contactForm', $i417760717250c854293598d2ff07a66629a1946d); return $this; } public function cartAddProductAddOptout(Varien_Event_Observer $i417760717250c854293598d2ff07a66629a1946d) { if (!Mage::helper('magesms')->isActive()) return $this; Mage::helper('magesms')->addOptoutProduct(true); return $this; } public function cartRemoveProductClearOptout(Varien_Event_Observer $i417760717250c854293598d2ff07a66629a1946d) { if (!Mage::helper('magesms')->isActive()) return $this; Mage::helper('magesms')->removeOptoutProduct(true); return $this; } public function lockSkuAttribute(Varien_Event_Observer $i417760717250c854293598d2ff07a66629a1946d) { if (!Mage::helper('magesms')->isActive()) return $this; $ic010a5d08128ec6abcd0a1a16cb1d8abe7bf2142 = Mage::getConfig()->getNode('default/config/optout')->sku; $i7fff76b02be2f63877a1782ca871e62a287fa16f = $i417760717250c854293598d2ff07a66629a1946d->getEvent(); $i69a1201e93806d55c970dfb18feec53d221ba37b = $i7fff76b02be2f63877a1782ca871e62a287fa16f->getProduct(); if ($i69a1201e93806d55c970dfb18feec53d221ba37b->getSku() == $ic010a5d08128ec6abcd0a1a16cb1d8abe7bf2142) $i69a1201e93806d55c970dfb18feec53d221ba37b->lockAttribute('sku'); return $this; } public function checkoutOrderOTP(Varien_Event_Observer $i417760717250c854293598d2ff07a66629a1946d) { if (Mage::app()->getStore()->isAdmin()) return $this; if (Mage::app()->getRequest()->getControllerModule() != 'Mage_Checkout') return $this; if (strpos($i417760717250c854293598d2ff07a66629a1946d->getEvent()->getBlock()->getTemplate(), 'button.phtml') === false) return $this; if (!Mage::helper('magesms')->isActive() || !Mage::helper('magesms')->getOtpOrderType()) return $this; if (strpos($i417760717250c854293598d2ff07a66629a1946d->getEvent()->getTransport()->getHtml(), 'review.save()') !== false) { $id82aaf2f437652c4b6efbd55703199f614e8e516 = $i417760717250c854293598d2ff07a66629a1946d->getEvent()->getTransport()->getHtml(); $id82aaf2f437652c4b6efbd55703199f614e8e516 = str_replace('review.save()', 'showMagesmsPopup(magesmsValidUrl)', $id82aaf2f437652c4b6efbd55703199f614e8e516); $i417760717250c854293598d2ff07a66629a1946d->getEvent()->getTransport()->setHtml($id82aaf2f437652c4b6efbd55703199f614e8e516); } return $this; } public function checkoutCustomerOTP(Varien_Event_Observer $i417760717250c854293598d2ff07a66629a1946d) { if (Mage::app()->getStore()->isAdmin()) return $this; if (Mage::app()->getRequest()->getControllerModule() != 'Mage_Checkout') return $this; if (strpos($i417760717250c854293598d2ff07a66629a1946d->getEvent()->getBlock()->getTemplate(), 'onepage/billing.phtml') === false) return $this; if (!Mage::helper('magesms')->isActive() || !Mage::helper('magesms')->getOtpCheckoutCustomerType()) return $this; $i30f20aafde612a957f7f966cb5b85e35782bc88a = Mage::helper('magesms')->getOtpCheckoutCustomerType(); $id82aaf2f437652c4b6efbd55703199f614e8e516 = $i417760717250c854293598d2ff07a66629a1946d->getEvent()->getTransport()->getHtml(); $i3358fd35282548f1f8ccafbf23d60a4ade466fd3 = "Translator.add('OTP SMS','".Mage::helper('magesms')->__('OTP SMS')."');"; $i3358fd35282548f1f8ccafbf23d60a4ade466fd3 .= "var magesmsValidUrl = '".Mage::getUrl('magesms/validate/checkout', array('_secure' => true))."';"; $i717aafa07eeca1a7c0f40cc18a0eb90e0984de3e = '1'; if ($i30f20aafde612a957f7f966cb5b85e35782bc88a == 2) $i717aafa07eeca1a7c0f40cc18a0eb90e0984de3e = 'checkout.method == "register"'; elseif ($i30f20aafde612a957f7f966cb5b85e35782bc88a == 3) $i717aafa07eeca1a7c0f40cc18a0eb90e0984de3e = 'checkout.method == "guest"'; $i3358fd35282548f1f8ccafbf23d60a4ade466fd3 .= '
Billing.prototype.save = function() {
	if (checkout.loadWaiting!=false) return;

        var validator = new Validation(this.form);
        if (validator.validate()) {
        	if ('.$i717aafa07eeca1a7c0f40cc18a0eb90e0984de3e.' && this.otpValid != true)
            	showMagesmsPopup(magesmsValidUrl);
            else
            	this.saveOTP();
        }
	}
Billing.prototype.saveOTP = function() {
	if (checkout.loadWaiting!=false) return;

        var validator = new Validation(this.form);
        if (validator.validate()) {
			checkout.setLoadWaiting(\'billing\');
			var request = new Ajax.Request(
				this.saveUrl,
				{
					method: \'post\',
					onComplete: this.onComplete,
					onSuccess: this.onSave,
					onFailure: checkout.ajaxFailure.bind(checkout),
					parameters: Form.serialize(this.form)
				}
			);
        }  
	}
'; $id82aaf2f437652c4b6efbd55703199f614e8e516 .= Mage::helper('core/js')->getScript($i3358fd35282548f1f8ccafbf23d60a4ade466fd3); $i417760717250c854293598d2ff07a66629a1946d->getEvent()->getTransport()->setHtml($id82aaf2f437652c4b6efbd55703199f614e8e516); return $this; } public function newOrderOTP(Varien_Event_Observer $i417760717250c854293598d2ff07a66629a1946d) { if (!Mage::helper('magesms')->isActive()) return $this; if (!Mage::helper('magesms')->getOtpOrderType() && !Mage::helper('magesms')->getOtpCheckoutCustomerType()) return $this; $i0e3e80cee9c51f140b823db0b7df66493acca657 = Mage::getSingleton('customer/session'); $i0976f5605544699720131549492b103937131569 = Mage::helper('magesms')->getOtpCheckoutCustomerType(); if ($i0976f5605544699720131549492b103937131569 == 3 && !$i417760717250c854293598d2ff07a66629a1946d->getEvent()->getOrder()->getCustomerIsGuest()) return $this; if ($i0976f5605544699720131549492b103937131569 == 3 && !$i417760717250c854293598d2ff07a66629a1946d->getEvent()->getOrder()->getCustomerIsGuest()) return $this; if (!$i0e3e80cee9c51f140b823db0b7df66493acca657->getData('magesms_validate_time')) return $this; if (!$i0e3e80cee9c51f140b823db0b7df66493acca657->getData('magesms_validate')) { $id567d29153b9150b8add34bc81058cd5432e46a0 = array(); $id567d29153b9150b8add34bc81058cd5432e46a0['success'] = false; $id567d29153b9150b8add34bc81058cd5432e46a0['error'] = true; $id567d29153b9150b8add34bc81058cd5432e46a0['error_messages'] = Mage::helper('magesms')->__('Wrong OTP code'); echo Mage::helper('core')->jsonEncode($id567d29153b9150b8add34bc81058cd5432e46a0); exit; } else { $i0e3e80cee9c51f140b823db0b7df66493acca657->unsetData('magesms_validate_time'); $i0e3e80cee9c51f140b823db0b7df66493acca657->unsetData('magesms_validate'); } return $this; } public function adminhtmlWidgetContainerHtmlBefore(Varien_Event_Observer $i417760717250c854293598d2ff07a66629a1946d) { $i8ee45e0018a32fb1a855b82624506e35789cc4d2 = $i417760717250c854293598d2ff07a66629a1946d->getBlock(); if ($i8ee45e0018a32fb1a855b82624506e35789cc4d2 instanceof Mage_Adminhtml_Block_Sales_Order_View || $i8ee45e0018a32fb1a855b82624506e35789cc4d2 instanceof Mage_Adminhtml_Block_Customer_Edit) { if (!Mage::helper('magesms')->isActive()) return $this; if ($i8ee45e0018a32fb1a855b82624506e35789cc4d2 instanceof Mage_Adminhtml_Block_Sales_Order_View) { $i19fc00f17cfbd9450ca7a66ef9471072f8709ccb = $i8ee45e0018a32fb1a855b82624506e35789cc4d2->getOrder()->getBillingAddress(); if (!$i19fc00f17cfbd9450ca7a66ef9471072f8709ccb) return $this; $id80f585d034617be5374dc980d71c1f97c179be2 = $i8ee45e0018a32fb1a855b82624506e35789cc4d2->getOrder()->getShippingAddress(); if (!$id80f585d034617be5374dc980d71c1f97c179be2) return $this; } else { $i77d22463fc16d92f418e384077adc971e57f8cd8 = Mage::registry('current_customer'); $i19fc00f17cfbd9450ca7a66ef9471072f8709ccb = $i77d22463fc16d92f418e384077adc971e57f8cd8->getDefaultBillingAddress(); $id80f585d034617be5374dc980d71c1f97c179be2 = $i77d22463fc16d92f418e384077adc971e57f8cd8->getDefaultShippingAddress(); if (!$id80f585d034617be5374dc980d71c1f97c179be2) return $this; } if (!$i19fc00f17cfbd9450ca7a66ef9471072f8709ccb && !$id80f585d034617be5374dc980d71c1f97c179be2) return $this; elseif ($i19fc00f17cfbd9450ca7a66ef9471072f8709ccb && !$id80f585d034617be5374dc980d71c1f97c179be2) $id80f585d034617be5374dc980d71c1f97c179be2 = $i19fc00f17cfbd9450ca7a66ef9471072f8709ccb; elseif (!$i19fc00f17cfbd9450ca7a66ef9471072f8709ccb && $id80f585d034617be5374dc980d71c1f97c179be2) $i19fc00f17cfbd9450ca7a66ef9471072f8709ccb = $id80f585d034617be5374dc980d71c1f97c179be2; $i6abff7c4dab2aa28578ae1dc49699ba6b1d18c18 = Mage::getSingleton('magesms/smsprofile'); if (!$i6abff7c4dab2aa28578ae1dc49699ba6b1d18c18->user->getPrefbilling()) { $i1f1945594819c4321de45ac15ed6d4dc07f41e2f = $i19fc00f17cfbd9450ca7a66ef9471072f8709ccb->getTelephone(); $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b = $i19fc00f17cfbd9450ca7a66ef9471072f8709ccb->getCountryId(); if (empty($i1f1945594819c4321de45ac15ed6d4dc07f41e2f) || !preg_match('/^[0-9+()\/\.\s-]+$/', $i1f1945594819c4321de45ac15ed6d4dc07f41e2f)) { $i1f1945594819c4321de45ac15ed6d4dc07f41e2f = $id80f585d034617be5374dc980d71c1f97c179be2->getTelephone(); $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b = $id80f585d034617be5374dc980d71c1f97c179be2->getCountryId(); } } else { $i1f1945594819c4321de45ac15ed6d4dc07f41e2f = $id80f585d034617be5374dc980d71c1f97c179be2->getTelephone(); $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b = $id80f585d034617be5374dc980d71c1f97c179be2->getCountryId(); if (empty($i1f1945594819c4321de45ac15ed6d4dc07f41e2f) || !preg_match('/^[0-9+()\/\.\s-]+$/', $i1f1945594819c4321de45ac15ed6d4dc07f41e2f)) { $i1f1945594819c4321de45ac15ed6d4dc07f41e2f = $i19fc00f17cfbd9450ca7a66ef9471072f8709ccb->getTelephone(); $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b = $i19fc00f17cfbd9450ca7a66ef9471072f8709ccb->getCountryId(); } } if (empty($i1f1945594819c4321de45ac15ed6d4dc07f41e2f) || !preg_match('/^[0-9+()\/\.\s-]+$/', $i1f1945594819c4321de45ac15ed6d4dc07f41e2f)) return $this; $i854b57231c05dbaa7f22331dbaed4152a402d2f1 = new Zend_Locale_Data(); $i065c883e3f45e58104d21f8196ee3fe9bd2f513d = $i854b57231c05dbaa7f22331dbaed4152a402d2f1->getList('en-EN', 'phonetoterritory'); $if0177bfe4bf22cfbb3da2ac06eca557829f0a4cd = ''; if ($idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b && $i065c883e3f45e58104d21f8196ee3fe9bd2f513d[$idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b] && !(strpos($i1f1945594819c4321de45ac15ed6d4dc07f41e2f, '+') === 0 || strpos($i1f1945594819c4321de45ac15ed6d4dc07f41e2f, '00') === 0)) { if (strpos($i1f1945594819c4321de45ac15ed6d4dc07f41e2f, '0') === 0) $i1f1945594819c4321de45ac15ed6d4dc07f41e2f = substr($i1f1945594819c4321de45ac15ed6d4dc07f41e2f, 1); $if0177bfe4bf22cfbb3da2ac06eca557829f0a4cd = $i065c883e3f45e58104d21f8196ee3fe9bd2f513d[$idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b]; } $i813c950729f632ca03f8c203c0a769de5e8bdf29 = Mage::helper('magesms')->prepareNumber($i1f1945594819c4321de45ac15ed6d4dc07f41e2f, Topefekt_Magesms_Model_Sms::TYPE_SIMPLE, $if0177bfe4bf22cfbb3da2ac06eca557829f0a4cd); if (empty($i813c950729f632ca03f8c203c0a769de5e8bdf29['mobile'])) return $this; $i8ee45e0018a32fb1a855b82624506e35789cc4d2->addButton('magesms_send_sms', array( 'label' => Mage::helper('magesms')->__('Send SMS'), 'onclick' => "setLocation('".Mage::helper("adminhtml")->getUrl('*/magesms_sendsms', array('recipients' => $i813c950729f632ca03f8c203c0a769de5e8bdf29['mobile']))."')", 'class' => 'go' )); } return $this; } public function cronUpdate() { if (!Mage::helper('magesms')->isActive()) return $this; $i36c92dc65e84acd6954001035d3b86efb10057bf = Mage::app()->loadCache('magesms_update_lastcheck'); $idef7cbe5fc44de57058ffe420bace11327a9b243 = 24 * 3600; if (($idef7cbe5fc44de57058ffe420bace11327a9b243 + $i36c92dc65e84acd6954001035d3b86efb10057bf) > time()) { return $this; } $i6abff7c4dab2aa28578ae1dc49699ba6b1d18c18 = Mage::getSingleton('magesms/smsprofile'); $ia61712c27ea241bd7a543dc2b02ea572274d0322 = 'action=showlastversion&username=' . urlencode($i6abff7c4dab2aa28578ae1dc49699ba6b1d18c18->user->user); $i55dd4e7042a1f9031b84f07f04c37165ce3d0720 = Mage::getModel('magesms/api')->serverPost($ia61712c27ea241bd7a543dc2b02ea572274d0322); if (!empty($i55dd4e7042a1f9031b84f07f04c37165ce3d0720) && !empty($i55dd4e7042a1f9031b84f07f04c37165ce3d0720['data'][0])) { if (version_compare($i55dd4e7042a1f9031b84f07f04c37165ce3d0720['data'][0], Mage::getConfig()->getModuleConfig('Topefekt_Magesms')->version) > 0) { Mage::app()->saveCache($i55dd4e7042a1f9031b84f07f04c37165ce3d0720['data'][0], 'magesms_update_available'); Mage::log("MageSms cron - new version {$i55dd4e7042a1f9031b84f07f04c37165ce3d0720['data'][0]} available"); } else Mage::app()->saveCache('', 'magesms_update_available'); } Mage::app()->saveCache(time(), 'magesms_update_lastcheck'); Mage::getSingleton('magesms/routes')->updatepricelist(); Mage::getSingleton('magesms/exceptions')->updateData(); return $this; } } 