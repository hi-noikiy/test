<?php
/**
 * Mage SMS - SMS notification & SMS marketing
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the BSD 3-Clause License
 * It is available through the world-wide-web at this URL:
 * http://opensource.org/licenses/BSD-3-Clause
 *
 * @category    TOPefekt
 * @package     TOPefekt_Magesms
 * @copyright   Copyright (c) 2012-2017 TOPefekt s.r.o. (http://www.mage-sms.com)
 * @license     http://opensource.org/licenses/BSD-3-Clause
 */
class Topefekt_Magesms_ValidateController extends Mage_Core_Controller_Front_Action { public function customerAction() { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e = new Varien_Object(); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(false); $i8ee45e0018a32fb1a855b82624506e35789cc4d2 = $this->getLayout()->createBlock('Topefekt_Magesms_Block_Validate_Customer'); $i0e3e80cee9c51f140b823db0b7df66493acca657 = Mage::getSingleton('customer/session'); $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2 = $this->getRequest(); if ($i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('smsnumber')) { $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_code', Mage::helper('magesms')->getOtpRandCode()); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate', false); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_mobile', $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('smsnumber')); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_time', time()); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f = Mage::getModel('magesms/sms'); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setIsFrontOffice(true); if (Mage::app()->getStore()) $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66 = Mage::app()->getStore()->getStoreId(); else $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66 = null; $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b = Mage::getStoreConfig('general/country/default', $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66);; $idb618c56be2c8abc9a54a16881dadfd5317ba624 = Mage::getSingleton('magesms/hooks_customers')->getCollection() ->addFieldToFilter('name', 'customerRegisterOTP') ->addFieldToFilter('mutation', Mage::getStoreConfig('general/locale/code', $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66)); if (!$idb618c56be2c8abc9a54a16881dadfd5317ba624->count()) { $i7137e40370cf1c5ccf937060891613788203e2d6 = Mage::getStoreConfig('general/locale/code', $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66); $idb618c56be2c8abc9a54a16881dadfd5317ba624 = Mage::getSingleton('magesms/hooks')->getCollection() ->addFieldToFilter('name', 'customerRegisterOTP') ->addFieldToFilter('lang', array_map('strtolower', explode('_', $i7137e40370cf1c5ccf937060891613788203e2d6))); } if (!$idb618c56be2c8abc9a54a16881dadfd5317ba624->count()) { $idb618c56be2c8abc9a54a16881dadfd5317ba624 = Mage::getSingleton('magesms/hooks')->getCollection() ->addFieldToFilter('name', 'customerRegisterOTP') ->addFieldToFilter('lang', 'en'); } if ($idb618c56be2c8abc9a54a16881dadfd5317ba624->count()) { $iefc930e6dfdf3023610ed7d663c73d176a7544e0 = $idb618c56be2c8abc9a54a16881dadfd5317ba624->getFirstItem(); if ($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getSmstext()) $iefc930e6dfdf3023610ed7d663c73d176a7544e0->setTemplate2($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getSmstext()); $i5e65dd16263683749d16a84171f719e768ed14b5 = new Varien_Object(array('code' => $i0e3e80cee9c51f140b823db0b7df66493acca657->getData('magesms_validate_code'))); $i24273814df383b4a6926acc1db1a788b12f5a411 = Mage::getModel('magesms/hooks')->prepareText($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getTemplate2(), 'customerRegisterOTP', $i5e65dd16263683749d16a84171f719e768ed14b5); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setMessage($i24273814df383b4a6926acc1db1a788b12f5a411) ->setSubject('customerRegisterOTP') ->addRecipient($i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('smsnumber'), array('country' => $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b)) ->setType(Topefekt_Magesms_Model_Sms::TYPE_CUSTOMER) ->setPriority(true) ->setStoreId($i3bf172bc34c83f4a18624b192bc0bd7c4d647a66); if ($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getMutation()) { $if2014d170e15e7f6f64523fd3238720980ceb64a = Mage::getSingleton('magesms/hooks_unicode')->getCollection() ->addFieldToFilter('type', 'customer') ->addFieldToFilter('area', $iefc930e6dfdf3023610ed7d663c73d176a7544e0->getMutation()); if ($if2014d170e15e7f6f64523fd3238720980ceb64a->count()) { $ie8d90f6313614fbb6564426c0b0cb59a0ca4cecd = $if2014d170e15e7f6f64523fd3238720980ceb64a->getFirstItem(); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setUnicode($ie8d90f6313614fbb6564426c0b0cb59a0ca4cecd->getUnicode()); } } $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setHookName('customerRegisterOTP'); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->send(); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_mobile', $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->getRecipient()->getFirstItem()->getFinalNumber()); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_time', time()); $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setNext(true); } } elseif ($i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('code')) { if ($id3e549697752385571e09ffe4add9278d2d6923b = $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('code')) { if ($i0e3e80cee9c51f140b823db0b7df66493acca657->getData('magesms_validate_time') <= time() - Mage::getStoreConfig('magesms/smsvalid/code_lifetime')) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(Mage::helper('magesms')->__('Code expired')); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setExpired(true); } elseif ($id3e549697752385571e09ffe4add9278d2d6923b == $i0e3e80cee9c51f140b823db0b7df66493acca657->getData('magesms_validate_code')) { $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate', true); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setValidate(true); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_time', time()); } else { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(Mage::helper('magesms')->__('Wrong OTP code')); } } } if (is_object($i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f)) { $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setSmsmobile('+'.$i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->getRecipient()->getFirstItem()->getFinalNumber()); } else { $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setSmsmobile($this->getRequest()->getParam('smsmobile')); } $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setHtml($i8ee45e0018a32fb1a855b82624506e35789cc4d2->toHtml()); $this->getResponse()->setBody($ia1a238c1f12f3901520c7ca55efa646e471f7f6e->toJson()); } public function checkoutAction() { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e = new Varien_Object(); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(false); $i8ee45e0018a32fb1a855b82624506e35789cc4d2 = $this->getLayout()->createBlock('Topefekt_Magesms_Block_Validate_Customer'); $i0e3e80cee9c51f140b823db0b7df66493acca657 = Mage::getSingleton('customer/session'); $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2 = $this->getRequest(); if ($i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('smsnumber')) { $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_code', Mage::helper('magesms')->getOtpRandCode()); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate', false); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_mobile', $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('smsnumber')); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_time', time()); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f = Mage::getModel('magesms/sms'); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setIsFrontOffice(true); if (Mage::app()->getStore()) $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66 = Mage::app()->getStore()->getStoreId(); else $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66 = null; $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b = Mage::getStoreConfig('general/country/default', $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66);; $idb618c56be2c8abc9a54a16881dadfd5317ba624 = Mage::getSingleton('magesms/hooks_customers')->getCollection() ->addFieldToFilter('name', 'checkoutCustomerOTP') ->addFieldToFilter('mutation', Mage::getStoreConfig('general/locale/code', $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66)); if (!$idb618c56be2c8abc9a54a16881dadfd5317ba624->count()) { $i7137e40370cf1c5ccf937060891613788203e2d6 = Mage::getStoreConfig('general/locale/code', $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66); $idb618c56be2c8abc9a54a16881dadfd5317ba624 = Mage::getSingleton('magesms/hooks')->getCollection() ->addFieldToFilter('name', 'checkoutCustomerOTP') ->addFieldToFilter('lang', array_map('strtolower', explode('_', $i7137e40370cf1c5ccf937060891613788203e2d6))); } if (!$idb618c56be2c8abc9a54a16881dadfd5317ba624->count()) { $idb618c56be2c8abc9a54a16881dadfd5317ba624 = Mage::getSingleton('magesms/hooks')->getCollection() ->addFieldToFilter('name', 'checkoutCustomerOTP') ->addFieldToFilter('lang', 'en'); } if ($idb618c56be2c8abc9a54a16881dadfd5317ba624->count()) { $iefc930e6dfdf3023610ed7d663c73d176a7544e0 = $idb618c56be2c8abc9a54a16881dadfd5317ba624->getFirstItem(); if ($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getSmstext()) $iefc930e6dfdf3023610ed7d663c73d176a7544e0->setTemplate2($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getSmstext()); $i5e65dd16263683749d16a84171f719e768ed14b5 = new Varien_Object(array('code' => $i0e3e80cee9c51f140b823db0b7df66493acca657->getData('magesms_validate_code'))); $i24273814df383b4a6926acc1db1a788b12f5a411 = Mage::getModel('magesms/hooks')->prepareText($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getTemplate2(), 'checkoutCustomerOTP', $i5e65dd16263683749d16a84171f719e768ed14b5); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setMessage($i24273814df383b4a6926acc1db1a788b12f5a411) ->setSubject('checkoutCustomerOTP') ->addRecipient($i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('smsnumber'), array('country' => $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b)) ->setType(Topefekt_Magesms_Model_Sms::TYPE_CUSTOMER) ->setPriority(true) ->setStoreId($i3bf172bc34c83f4a18624b192bc0bd7c4d647a66); if ($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getMutation()) { $if2014d170e15e7f6f64523fd3238720980ceb64a = Mage::getSingleton('magesms/hooks_unicode')->getCollection() ->addFieldToFilter('type', 'customer') ->addFieldToFilter('area', $iefc930e6dfdf3023610ed7d663c73d176a7544e0->getMutation()); if ($if2014d170e15e7f6f64523fd3238720980ceb64a->count()) { $ie8d90f6313614fbb6564426c0b0cb59a0ca4cecd = $if2014d170e15e7f6f64523fd3238720980ceb64a->getFirstItem(); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setUnicode($ie8d90f6313614fbb6564426c0b0cb59a0ca4cecd->getUnicode()); } } $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setHookName('checkoutCustomerOTP'); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->send(); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_mobile', $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->getRecipient()->getFirstItem()->getFinalNumber()); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_time', time()); $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setNext(true); } } elseif ($i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('code')) { if ($id3e549697752385571e09ffe4add9278d2d6923b = $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('code')) { if ($i0e3e80cee9c51f140b823db0b7df66493acca657->getData('magesms_validate_time') <= time() - Mage::getStoreConfig('magesms/smsvalid/code_lifetime')) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(Mage::helper('magesms')->__('Code expired')); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setExpired(true); } elseif ($id3e549697752385571e09ffe4add9278d2d6923b == $i0e3e80cee9c51f140b823db0b7df66493acca657->getData('magesms_validate_code')) { $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate', true); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setValidate(true); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setCheckout(true); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_time', time()); } else { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(Mage::helper('magesms')->__('Wrong OTP code')); } } } if (is_object($i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f)) { $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setSmsmobile('+'.$i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->getRecipient()->getFirstItem()->getFinalNumber()); } else { $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setSmsmobile($this->getRequest()->getParam('smsmobile')); } $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setHtml($i8ee45e0018a32fb1a855b82624506e35789cc4d2->toHtml()); $this->getResponse()->setBody($ia1a238c1f12f3901520c7ca55efa646e471f7f6e->toJson()); } public function orderAction() { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e = new Varien_Object(); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(false); $i8ee45e0018a32fb1a855b82624506e35789cc4d2 = $this->getLayout()->createBlock('Topefekt_Magesms_Block_Validate_Customer'); $i0e3e80cee9c51f140b823db0b7df66493acca657 = Mage::getSingleton('customer/session'); $if506786cc1cb35bcbc32166723b30959581284aa = Mage::getSingleton('checkout/type_onepage')->getQuote(); $i6abff7c4dab2aa28578ae1dc49699ba6b1d18c18 = Mage::getSingleton('magesms/smsprofile'); if (!$i6abff7c4dab2aa28578ae1dc49699ba6b1d18c18->user->getPrefbilling()) { $i1f1945594819c4321de45ac15ed6d4dc07f41e2f = $if506786cc1cb35bcbc32166723b30959581284aa->getBillingAddress()->getTelephone(); $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b = $if506786cc1cb35bcbc32166723b30959581284aa->getBillingAddress()->getCountryId(); if (empty($i1f1945594819c4321de45ac15ed6d4dc07f41e2f) || !preg_match('/^[0-9+()\/\.\s-]+$/', $i1f1945594819c4321de45ac15ed6d4dc07f41e2f)) { $i1f1945594819c4321de45ac15ed6d4dc07f41e2f = $if506786cc1cb35bcbc32166723b30959581284aa->getShippingAddress()->getTelephone(); $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b = $if506786cc1cb35bcbc32166723b30959581284aa->getShippingAddress()->getCountryId(); } } else { $i1f1945594819c4321de45ac15ed6d4dc07f41e2f = $if506786cc1cb35bcbc32166723b30959581284aa->getShippingAddress()->getTelephone(); $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b = $if506786cc1cb35bcbc32166723b30959581284aa->getShippingAddress()->getCountryId(); if (empty($i1f1945594819c4321de45ac15ed6d4dc07f41e2f) || !preg_match('/^[0-9+()\/\.\s-]+$/', $i1f1945594819c4321de45ac15ed6d4dc07f41e2f)) { $i1f1945594819c4321de45ac15ed6d4dc07f41e2f = $if506786cc1cb35bcbc32166723b30959581284aa->getBillingAddress()->getTelephone(); $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b = $if506786cc1cb35bcbc32166723b30959581284aa->getBillingAddress()->getCountryId(); } } if (empty($i1f1945594819c4321de45ac15ed6d4dc07f41e2f) || !preg_match('/^[0-9+()\/\.\s-]+$/', $i1f1945594819c4321de45ac15ed6d4dc07f41e2f)) $i1f1945594819c4321de45ac15ed6d4dc07f41e2f = ''; if ($i1f1945594819c4321de45ac15ed6d4dc07f41e2f && !$this->getRequest()->getParam('code')) { $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_code', Mage::helper('magesms')->getOtpRandCode()); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate', false); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_mobile', $i1f1945594819c4321de45ac15ed6d4dc07f41e2f); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_time', time()); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f = Mage::getModel('magesms/sms'); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setIsFrontOffice(true); if (Mage::app()->getStore()) $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66 = Mage::app()->getStore()->getStoreId(); else $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66 = null; if (empty($idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b)) $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b = Mage::getStoreConfig('general/country/default', $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66);; $idb618c56be2c8abc9a54a16881dadfd5317ba624 = Mage::getSingleton('magesms/hooks_customers')->getCollection() ->addFieldToFilter('name', 'newOrderOTP') ->addFieldToFilter('mutation', Mage::getStoreConfig('general/locale/code', $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66)); if (!$idb618c56be2c8abc9a54a16881dadfd5317ba624->count()) { $i7137e40370cf1c5ccf937060891613788203e2d6 = Mage::getStoreConfig('general/locale/code', $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66); $idb618c56be2c8abc9a54a16881dadfd5317ba624 = Mage::getSingleton('magesms/hooks')->getCollection() ->addFieldToFilter('name', 'newOrderOTP') ->addFieldToFilter('lang', array_map('strtolower', explode('_', $i7137e40370cf1c5ccf937060891613788203e2d6))); } if (!$idb618c56be2c8abc9a54a16881dadfd5317ba624->count()) { $idb618c56be2c8abc9a54a16881dadfd5317ba624 = Mage::getSingleton('magesms/hooks')->getCollection() ->addFieldToFilter('name', 'newOrderOTP') ->addFieldToFilter('lang', 'en'); } if ($idb618c56be2c8abc9a54a16881dadfd5317ba624->count()) { $iefc930e6dfdf3023610ed7d663c73d176a7544e0 = $idb618c56be2c8abc9a54a16881dadfd5317ba624->getFirstItem(); if ($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getSmstext()) $iefc930e6dfdf3023610ed7d663c73d176a7544e0->setTemplate2($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getSmstext()); $i5e65dd16263683749d16a84171f719e768ed14b5 = new Varien_Object(array('code' => $i0e3e80cee9c51f140b823db0b7df66493acca657->getData('magesms_validate_code'))); $i24273814df383b4a6926acc1db1a788b12f5a411 = Mage::getModel('magesms/hooks')->prepareText($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getTemplate2(), 'newOrderOTP', $i5e65dd16263683749d16a84171f719e768ed14b5); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setMessage($i24273814df383b4a6926acc1db1a788b12f5a411) ->setSubject('newOrderOTP') ->addRecipient($i1f1945594819c4321de45ac15ed6d4dc07f41e2f, array('country' => $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b, 'recipient' => $if506786cc1cb35bcbc32166723b30959581284aa->getCustomerFirstname().' '.$if506786cc1cb35bcbc32166723b30959581284aa->getCustomerLastname())) ->setType(Topefekt_Magesms_Model_Sms::TYPE_CUSTOMER) ->setPriority(true) ->setStoreId($i3bf172bc34c83f4a18624b192bc0bd7c4d647a66); if ($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getMutation()) { $if2014d170e15e7f6f64523fd3238720980ceb64a = Mage::getSingleton('magesms/hooks_unicode')->getCollection() ->addFieldToFilter('type', 'customer') ->addFieldToFilter('area', $iefc930e6dfdf3023610ed7d663c73d176a7544e0->getMutation()); if ($if2014d170e15e7f6f64523fd3238720980ceb64a->count()) { $ie8d90f6313614fbb6564426c0b0cb59a0ca4cecd = $if2014d170e15e7f6f64523fd3238720980ceb64a->getFirstItem(); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setUnicode($ie8d90f6313614fbb6564426c0b0cb59a0ca4cecd->getUnicode()); } } $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setHookName('newOrderOTP'); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->send(); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_mobile', $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->getRecipient()->getFirstItem()->getFinalNumber()); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_time', time()); $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setNext(true); } } elseif ($id3e549697752385571e09ffe4add9278d2d6923b = $this->getRequest()->getParam('code')) { if ($i0e3e80cee9c51f140b823db0b7df66493acca657->getData('magesms_validate_time') <= time() - Mage::getStoreConfig('magesms/smsvalid/code_lifetime')) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(Mage::helper('magesms')->__('Code expired')); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setExpired(true); } elseif ($id3e549697752385571e09ffe4add9278d2d6923b == $i0e3e80cee9c51f140b823db0b7df66493acca657->getData('magesms_validate_code')) { $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate', true); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setValidate(true); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setOrder(true); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_time', time()); } else { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(Mage::helper('magesms')->__('Wrong OTP code')); } } if (is_object($i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f)) { $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setSmsmobile('+'.$i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->getRecipient()->getFirstItem()->getFinalNumber()); } else { $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setSmsmobile($i1f1945594819c4321de45ac15ed6d4dc07f41e2f); } $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setHtml($i8ee45e0018a32fb1a855b82624506e35789cc4d2->toHtml()); $this->getResponse()->setBody($ia1a238c1f12f3901520c7ca55efa646e471f7f6e->toJson()); } public function mobileAction() { if (!Mage::helper('magesms')->isActive()) return $this; if (Mage::helper('magesms')->getOtpCustomerType() != 1) { $this->_redirect('customer/account/create'); return $this; } $if3b1e2c1706de4c1bca112c669caba3a0420b880 = ''; if ($this->getRequest()->isPost()) { $i0e3e80cee9c51f140b823db0b7df66493acca657 = Mage::getSingleton('customer/session'); if (!$i0e3e80cee9c51f140b823db0b7df66493acca657->getData('magesms_validate_code') || ($this->getRequest()->getParam('mobile') && !$this->getRequest()->getParam('code')) || $i0e3e80cee9c51f140b823db0b7df66493acca657->getData('magesms_validate_time') <= time()-Mage::getStoreConfig('magesms/smsvalid/session_lifetime')) { $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_code', Mage::helper('magesms')->getOtpRandCode()); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate', false); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_mobile', ''); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_time', time()); } if ($id3e549697752385571e09ffe4add9278d2d6923b = $this->getRequest()->getParam('code')) { if ($i0e3e80cee9c51f140b823db0b7df66493acca657->getData('magesms_validate_time') <= time()-Mage::getStoreConfig('magesms/smsvalid/code_lifetime')) { $this->getLayout()->getMessagesBlock()->addError(Mage::helper('magesms')->__('Code expired')); $this->_redirect('*/*/*'); } elseif ($id3e549697752385571e09ffe4add9278d2d6923b == $i0e3e80cee9c51f140b823db0b7df66493acca657->getData('magesms_validate_code')) { $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate', true); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_time', time()); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_mobile', $this->getRequest()->getParam('mobile')); $this->_redirect('customer/account/create'); return $this; } else { $if3b1e2c1706de4c1bca112c669caba3a0420b880 = Mage::helper('magesms')->__('Wrong OTP code'); } } else { $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f = Mage::getModel('magesms/sms'); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setIsFrontOffice(true); if (Mage::app()->getStore()) $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66 = Mage::app()->getStore()->getStoreId(); else $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66 = null; $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b = Mage::getStoreConfig('general/country/default', $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66);; $idb618c56be2c8abc9a54a16881dadfd5317ba624 = Mage::getSingleton('magesms/hooks_customers')->getCollection() ->addFieldToFilter('name', 'customerRegisterOTP') ->addFieldToFilter('mutation', Mage::getStoreConfig('general/locale/code', $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66)); if (!$idb618c56be2c8abc9a54a16881dadfd5317ba624->count()) { $i7137e40370cf1c5ccf937060891613788203e2d6 = Mage::getStoreConfig('general/locale/code', $i3bf172bc34c83f4a18624b192bc0bd7c4d647a66); $idb618c56be2c8abc9a54a16881dadfd5317ba624 = Mage::getSingleton('magesms/hooks')->getCollection() ->addFieldToFilter('name', 'customerRegisterOTP') ->addFieldToFilter('lang', array_map('strtolower', explode('_', $i7137e40370cf1c5ccf937060891613788203e2d6))); } if (!$idb618c56be2c8abc9a54a16881dadfd5317ba624->count()) { $idb618c56be2c8abc9a54a16881dadfd5317ba624 = Mage::getSingleton('magesms/hooks')->getCollection() ->addFieldToFilter('name', 'customerRegisterOTP') ->addFieldToFilter('lang', 'en'); } if ($idb618c56be2c8abc9a54a16881dadfd5317ba624->count()) { $iefc930e6dfdf3023610ed7d663c73d176a7544e0 = $idb618c56be2c8abc9a54a16881dadfd5317ba624->getFirstItem(); if ($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getSmstext()) $iefc930e6dfdf3023610ed7d663c73d176a7544e0->setTemplate2($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getSmstext()); $i5e65dd16263683749d16a84171f719e768ed14b5 = new Varien_Object(array('code' => $i0e3e80cee9c51f140b823db0b7df66493acca657->getData('magesms_validate_code'))); $i24273814df383b4a6926acc1db1a788b12f5a411 = Mage::getModel('magesms/hooks')->prepareText($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getTemplate2(), 'customerRegisterOTP', $i5e65dd16263683749d16a84171f719e768ed14b5); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setMessage($i24273814df383b4a6926acc1db1a788b12f5a411) ->setSubject('customerRegisterOTP') ->addRecipient($this->getRequest()->getParam('mobile'), array('country' => $idcde4f5fb5532c8e634fa3aa4c7ce182a046d76b)) ->setType(Topefekt_Magesms_Model_Sms::TYPE_CUSTOMER) ->setPriority(true) ->setStoreId($i3bf172bc34c83f4a18624b192bc0bd7c4d647a66); if ($iefc930e6dfdf3023610ed7d663c73d176a7544e0->getMutation()) { $if2014d170e15e7f6f64523fd3238720980ceb64a = Mage::getSingleton('magesms/hooks_unicode')->getCollection() ->addFieldToFilter('type', 'customer') ->addFieldToFilter('area', $iefc930e6dfdf3023610ed7d663c73d176a7544e0->getMutation()); if ($if2014d170e15e7f6f64523fd3238720980ceb64a->count()) { $ie8d90f6313614fbb6564426c0b0cb59a0ca4cecd = $if2014d170e15e7f6f64523fd3238720980ceb64a->getFirstItem(); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setUnicode($ie8d90f6313614fbb6564426c0b0cb59a0ca4cecd->getUnicode()); } } $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->setHookName('customerRegisterOTP'); $i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->send(); $i0e3e80cee9c51f140b823db0b7df66493acca657->setData('magesms_validate_time', time()); } } } $this->loadLayout(); $this->_initLayoutMessages('customer/session'); $this->_initLayoutMessages('catalog/session'); if ($if3b1e2c1706de4c1bca112c669caba3a0420b880) $this->getLayout()->getMessagesBlock()->addError($if3b1e2c1706de4c1bca112c669caba3a0420b880); if ($this->getRequest()->isPost() && Mage::getSingleton('core/session')->getMessages()->getLastAddedMessage() instanceof Mage_Core_Model_Message_Success ) { $i8ee45e0018a32fb1a855b82624506e35789cc4d2 = $this->getLayout()->getBlock('magesms_validate_mobile'); $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setNext(true); if (is_object($i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f)) { $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setMobile('+'.$i2012325f8714e1168a6c4fd06b9fa8eee23fcc7f->getRecipient()->getFirstItem()->getFinalNumber()); } else { $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setMobile($this->getRequest()->getParam('mobile')); } } $this->renderLayout(); } }